#!/usr/bin/env bash
#
# Test zone management operations for qcow2 file.
#

seq="$(basename $0)"
echo "QA output created by $seq"
status=1 # failure is the default!

file_name="zbc.qcow2"
_cleanup()
{
  _cleanup_test_img
  _rm_test_img "$file_name"
}
trap "_cleanup; exit \$status" 0 1 2 3 15

# get standard environment, filters and checks
. ../common.rc
. ../common.filter
. ../common.qemu

# This test only runs on Linux hosts with qcow2 image files.
_supported_proto file
_supported_os Linux

echo
echo "=== Initial image setup ==="
echo

$QEMU_IMG create -f qcow2 $file_name -o size=768M -o zone_size=64M \
-o zone_capacity=64M -o zone_nr_conv=0 -o max_append_sectors=512 \
-o max_open_zones=0 -o max_active_zones=0 -o zoned_profile=zbc

IMG="--image-opts -n driver=qcow2,file.driver=file,file.filename=$file_name"
QEMU_IO_OPTIONS=$QEMU_IO_OPTIONS_NO_FMT

echo
echo "=== Testing a qcow2 img with zoned format ==="
echo
echo "case 1: if the operations work"

echo "(1) report the first zone:"
$QEMU_IO $IMG -c "zrp 0 1"
echo
echo "report the first 10 zones"
$QEMU_IO $IMG -c "zrp 0 10"
echo
echo "report the last zone:"
$QEMU_IO $IMG -c "zrp 0x2C000000 2" # 0x2C000000 / 512 = 0x160000
echo
echo
echo "(2) opening the first zone"
$QEMU_IO $IMG -c "zo 0 0x4000000" # 0x4000000 / 512 = 0x20000
echo "report after:"
$QEMU_IO $IMG -c "zrp 0 1"
echo
echo "opening the second zone"
$QEMU_IO $IMG -c "zo 0x4000000 0x4000000"
echo "report after:"
$QEMU_IO $IMG -c "zrp 0x4000000 1"
echo
echo "opening the last zone"
$QEMU_IO $IMG -c "zo 0x2C000000 0x4000000"
echo "report after:"
$QEMU_IO $IMG -c "zrp 0x2C000000 2"
echo
echo
echo "(3) closing the first zone"
$QEMU_IO $IMG -c "zc 0 0x4000000"
echo "report after:"
$QEMU_IO $IMG -c "zrp 0 1"
echo
echo "closing the last zone"
$QEMU_IO $IMG -c "zc 0x3e70000000 0x4000000"
echo "report after:"
$QEMU_IO $IMG -c "zrp 0x3e70000000 2"
echo
echo
echo "(4) finishing the second zone"
$QEMU_IO $IMG -c "zf 0x4000000 0x4000000"
echo "After finishing a zone:"
$QEMU_IO $IMG -c "zrp 0x4000000 1"
echo
echo
echo "(5) resetting the second zone"
$QEMU_IO $IMG -c "zrs 0x4000000 0x4000000"
echo "After resetting a zone:"
$QEMU_IO $IMG -c "zrp 0x4000000 1"
echo
echo
echo "(6) append write" # the physical block size of the device is 4096
$QEMU_IO $IMG -c "zrp 0 1"
$QEMU_IO $IMG -c "zap -p 0 0x1000 0x2000"
echo "After appending the first zone firstly:"
$QEMU_IO $IMG -c "zrp 0 1"
$QEMU_IO $IMG -c "zap -p 0 0x1000 0x2000"
echo "After appending the first zone secondly:"
$QEMU_IO $IMG -c "zrp 0 1"
$QEMU_IO $IMG -c "zap -p 0x4000000 0x1000 0x2000"
echo "After appending the second zone firstly:"
$QEMU_IO $IMG -c "zrp 0x4000000 1"
$QEMU_IO $IMG -c "zap -p 0x4000000 0x1000 0x2000"
echo "After appending the second zone secondly:"
$QEMU_IO $IMG -c "zrp 0x4000000 1"

# success, all done
echo "*** done"
rm -f $seq.full
status=0
